# 消息路径流转梳理

为了更好地构建AI Agent workflow，梳理一下整个信息流转的过程。

## 1、前端页面 web/index.html

用户通过对话框发送消息

web/index.html，sendMessage()函数

```python
// 用户在输入框输入消息后点击发送
sendMessage() {
    // ① 获取消息内容
    // ② 调用 POST /api/chat 接口
    fetch('/api/chat', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${authToken}`,  // JWT认证
        },
        body: JSON.stringify({
            message: message,
            session_id: currentSessionId,    // 会话ID
            context_length: 10,              // 上下文长度
            include_summary: true            // 是否包含摘要
        })
    })
}
```

前端调用前端和后端服务器之间的接口，这个接口叫/api/chat

调用方法：POST（HTTP），意思是“向服务器提交数据”

路径：/api/chat，也被称为API端点（endpoint）

数据：body中的信息，一般数据会被打包成JSON格式

后端服务器 FastAPI应用一直在监听/api/chat这个地址，当他收到请求后，会解析message

## 2、后端接口 server/main.py

后端服务器收到聊天请求时（也就是POST)

后端的send_message函数要经过如下步骤来确认信息：

1. 认证检查 Authentication，也就是服务器首先要确认“你是谁”，他会从请求的authorization header里拿到一个token，然后调用auth.get_current_user函数来验证token是否有效，以及找到是哪个用户在发消息
2. message中有个session_id，后端会用这个来判断是一段新对话还是已经存在的对话；如果是新的对话，服务器会调用chat_history.create_session来创建一个新的会话记录，并把新的消息存进去。
3. 保存用户信息。用户的信息会被保存在数据库中。
4. 构建对话上下文：读取最近的N条信息，现在设置为10条。
5. 调用chat.generate_response函数，把当前的消息和第四步构建的上下文一起发送给AI，等待AI生成回复
6. 拿到AI生成的回复后，服务器会再次调用chat_history.add_message，把AI的回复也保存在数据库里
7. 最后，服务器把AI的回复、会话ID等信息打包成一个JSON格式的响应，发送回给前端，前端再把这个回复显示给用户看

所以我们在第五步这里截断，将信息转发到brain/brain.py中，然后brain.py返回结果，即可实现无缝切换。

完整流转路径如下：

```
用户输入消息
    ↓
【前端】sendMessage()
    ↓
POST /api/chat
    ↓ (携带: message, session_id, JWT token)
    ↓
【后端 main.py】send_message()
    ├─ ① 验证JWT Token (get_current_user)
    ├─ ② 确定/创建会话 (chat_history.create_session)
    ├─ ③ 保存用户消息 (chat_history.add_message)
    ├─ ④ 获取上下文 (chat_history.build_conversation_context)
    ├─ ⑤ 生成AI回复 ↓
    │
    └──→【chat.py】generate_response()
         ├─ 构建消息列表 (system + context + user)
         └─ call_ai_api()
             ├─ 构建HTTP请求
             ├─ 调用 DeepSeek API
             └─ 返回 AI 回复
    ↓
【后端】保存AI回复 (chat_history.add_message)
    ↓
返回 JSON 响应
    ↓ (包含: response, session_id, message_id, timestamp)
    ↓
【前端】接收响应
    ├─ addMessage() 渲染消息
    ├─ marked.parse() 渲染Markdown
    └─ loadChatHistory() 刷新历史
    ↓
用户看到AI回复 ✅
```

..
