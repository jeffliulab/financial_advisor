# 布局动态监听系统说明

## 📌 快速开始

### 脚本获取UI状态

```python
import requests

# 获取当前UI状态
response = requests.get('http://localhost:8000/api/ui/state')
data = response.json()

print(data['current_state'])
# 输出: {'dashboard_active': True, 'current_tool': 'budget-planner', 'layout_mode': 'three-column'}
```

### 脚本控制UI布局

```python
import requests

# 打开工具（三栏布局）
requests.post('http://localhost:8000/api/ui/command', json={
    "command": "open_dashboard",
    "params": {"tool": "budget-planner"}
})

# 关闭工具（恢复二栏）
requests.post('http://localhost:8000/api/ui/command', json={
    "command": "close_dashboard",
    "params": {}
})
```

---

## 🎨 两种布局模式

### 二栏布局（默认）
```
┌────────────┬──────────────────────────────┐
│  Sidebar   │      Chat Container          │
│  (280px)   │      (flex: 1)               │
└────────────┴──────────────────────────────┘
```

### 三栏布局（工具激活）
```
┌────────────┬──────────────────┬──────────────────┐
│  Sidebar   │  Dashboard Panel │  Chat Container  │
│  (280px)   │  (flex: 1)       │  (400px)         │
└────────────┴──────────────────┴──────────────────┘
```

---

## 🔄 核心机制：来源标记

系统通过 `source` 标记区分状态变更来源，避免重复执行：

```
状态变更
    ↓
┌───────────────────────────────────┐
│  来源标记？                        │
├───────────────────────────────────┤
│  source: "frontend"               │
│  → 用户点击按钮                   │
│  → 前端立即切换（0ms）            │
│  → 同步状态到后端                 │
│  → 后端只记录，不生成命令 ✅      │
│  → 轮询器不会重复执行             │
├───────────────────────────────────┤
│  source: "backend"                │
│  → Agent/脚本发送命令             │
│  → 后端生成命令到队列             │
│  → 前端轮询获取并执行             │
│  → 执行后同步状态（frontend）✅   │
│  → 不会再次生成命令               │
└───────────────────────────────────┘
```

---

## 📡 API接口

### 1. GET /api/ui/state
获取UI状态和待执行命令（前端每2秒轮询）

**响应：**
```json
{
  "pending_commands": [
    {
      "command": "open_dashboard",
      "params": {"tool": "budget-planner"},
      "command_id": "cmd_xxx",
      "source": "backend"
    }
  ],
  "current_state": {
    "dashboard_active": false,
    "current_tool": null,
    "layout_mode": "two-column"
  }
}
```

---

### 2. POST /api/ui/command
Agent/脚本发送UI控制命令（source: backend）

**请求：**
```json
{
  "command": "open_dashboard",
  "params": {"tool": "budget-planner"}
}
```

**支持的命令：**
- `open_dashboard` - 打开工具（三栏）
- `close_dashboard` - 关闭工具（二栏）
- `switch_session` - 切换会话

**响应：**
```json
{
  "success": true,
  "command_id": "cmd_20251024_120000_abc123",
  "source": "backend"
}
```

---

### 3. POST /api/ui/state/sync
前端同步状态到后端（source: frontend）

**请求：**
```json
{
  "dashboard_active": true,
  "current_tool": "budget-planner",
  "layout_mode": "three-column",
  "source": "frontend"
}
```

**响应：**
```json
{
  "success": true,
  "message": "State synced (no command generated)",
  "current_state": {...}
}
```

---

## 🔁 完整流程图

### 用户点击按钮

```
用户点击按钮
    ↓
前端立即切换布局（0ms）
    ↓
POST /api/ui/state/sync {source: "frontend"}
    ↓
后端更新状态，不生成命令
    ↓
完成（不会重复执行）
```

### Agent控制UI

```
Agent发送命令
    ↓
POST /api/ui/command {source: "backend"}
    ↓
后端生成命令到队列 + 更新状态
    ↓
前端轮询获取命令（2秒内）
    ↓
前端执行切换
    ↓
POST /api/ui/state/sync {source: "frontend"}
    ↓
后端更新状态，不生成新命令
    ↓
完成
```

---

## 💻 使用示例

### Python Agent示例

```python
import requests

BASE_URL = "http://localhost:8000"

class UIController:
    def __init__(self):
        self.base_url = BASE_URL
    
    def get_state(self):
        """获取当前UI状态"""
        response = requests.get(f"{self.base_url}/api/ui/state")
        return response.json()['current_state']
    
    def open_tool(self, tool_name):
        """打开工具"""
        requests.post(f"{self.base_url}/api/ui/command", json={
            "command": "open_dashboard",
            "params": {"tool": tool_name}
        })
    
    def close_tool(self):
        """关闭工具"""
        requests.post(f"{self.base_url}/api/ui/command", json={
            "command": "close_dashboard",
            "params": {}
        })

# 使用
ui = UIController()

# 检查状态
state = ui.get_state()
if not state['dashboard_active']:
    ui.open_tool('budget-planner')
```

### 浏览器控制台测试

```javascript
// 查看当前状态
fetch('/api/ui/state').then(r => r.json()).then(console.log)

// Agent方式：发送命令（通过队列）
fetch('/api/ui/command', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
        command: 'open_dashboard',
        params: {tool: 'spending-analyzer'}
    })
}).then(r => r.json()).then(console.log)

// 前端方式：直接点击按钮（立即执行）
sendButtonEvent('budget-planner')
```

---

## 🎯 关键优势

| 特性 | 说明 |
|------|------|
| **0延迟响应** | 用户点击按钮立即切换，无需等待 |
| **无重复执行** | 通过source标记避免重复 |
| **状态一致** | 前后端状态实时同步 |
| **Agent友好** | 任何脚本都能控制UI |
| **简单架构** | HTTP轮询，无需WebSocket |

---

## 🔧 配置

### 轮询频率

修改 `web/index.html`:
```javascript
const UI_POLL_INTERVAL = 2000;  // 2秒（默认）
```

### 持久化

生产环境建议使用Redis存储UI状态：
```python
import redis
redis_client = redis.Redis()

# 存储
redis_client.set('ui_state', json.dumps(current_ui_state))

# 读取
current_ui_state = json.loads(redis_client.get('ui_state'))
```

---

## 🐛 调试

### 查看日志

浏览器控制台（F12）：
```
🔘 Button Clicked: budget-planner
✅ Switched to: budget-planner
✅ State synced to backend

// Agent触发时
🎯 New UI Command Received: {...}
⚡ Executing Command: open_dashboard
✅ Dashboard Opened: budget-planner
✅ State synced to backend
```

### 查看状态

```bash
# 命令行查询
curl http://localhost:8000/api/ui/state | jq .current_state
```

---

## 📚 相关文档

- **API详细文档**: 查看 `web/index.html` 开头注释
- **后端实现**: `server/main.py` - UI控制系统部分
- **前端实现**: `web/index.html` - UI Dynamic Control System

---

**版本**: v2.0 - 基于来源标记的智能状态管理
